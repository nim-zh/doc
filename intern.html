<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!--  This file is generated by Nimrod. -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

<!-- Favicon -->
<link rel="shortcut icon" href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AAAAAAUAAAAF////AP///wD///8A////AP///wD///8A////AP///wD///8A////AAAAAAIAAABbAAAAlQAAAKIAAACbAAAAmwAAAKIAAACVAAAAWwAAAAL///8A////AP///wD///8A////AAAAABQAAADAAAAAYwAAAA3///8A////AP///wD///8AAAAADQAAAGMAAADAAAAAFP///wD///8A////AP///wAAAACdAAAAOv///wD///8A////AP///wD///8A////AP///wD///8AAAAAOgAAAJ3///8A////AP///wAAAAAnAAAAcP///wAAAAAoAAAASv///wD///8A////AP///wAAAABKAAAAKP///wAAAABwAAAAJ////wD///8AAAAAgQAAABwAAACIAAAAkAAAAJMAAACtAAAAFQAAABUAAACtAAAAkwAAAJAAAACIAAAAHAAAAIH///8A////AAAAAKQAAACrAAAAaP///wD///8AAAAARQAAANIAAADSAAAARf///wD///8AAAAAaAAAAKsAAACk////AAAAADMAAACcAAAAnQAAABj///8A////AP///wAAAAAYAAAAGP///wD///8A////AAAAABgAAACdAAAAnAAAADMAAAB1AAAAwwAAAP8AAADpAAAAsQAAAE4AAAAb////AP///wAAAAAbAAAATgAAALEAAADpAAAA/wAAAMMAAAB1AAAAtwAAAOkAAAD/AAAA/wAAAP8AAADvAAAA3gAAAN4AAADeAAAA3gAAAO8AAAD/AAAA/wAAAP8AAADpAAAAtwAAAGUAAAA/AAAA3wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAADfAAAAPwAAAGX///8A////AAAAAEgAAADtAAAAvwAAAL0AAADGAAAA7wAAAO8AAADGAAAAvQAAAL8AAADtAAAASP///wD///8A////AP///wD///8AAAAAO////wD///8A////AAAAAIcAAACH////AP///wD///8AAAAAO////wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A//8AAP//AAD4HwAA7/cAAN/7AAD//wAAoYUAAJ55AACf+QAAh+EAAAAAAADAAwAA4AcAAP5/AAD//wAA//8AAA=="/>

<!-- Google fonts -->
<link href='http://fonts.googleapis.com/css?family=Raleway:400,600,900' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Source+Code+Pro:400,500,600' rel='stylesheet' type='text/css'>

<!-- CSS -->
<title>Internals of the Nim Compiler</title>
<style type="text/css" >
/*
Stylesheet for use with Docutils/rst2html.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.

Modified from Chad Skeeters' rst2html-style
https://bitbucket.org/cskeeters/rst2html-style/

Modified by Boyd Greenfield
*/
/* SCSS variables */
/* Text weights */
/* Body colors */
/* Text colors */
/* Link colors */
/* Syntax highlighting colors */
/* Pct changes */
/* Mixins */
/* Body/layout */
html {
  font-size: 100%;
  -webkit-text-size-adjust: 100%;
  -ms-text-size-adjust: 100%; }

/* Where we want fancier font if available */
h1, h2, h3, h4, h5, h6, p.module-desc, table.docinfo + blockquote p, table.docinfo blockquote p, h1 + blockquote p {
  font-family: "Raleway", "Helvetica Neue", "HelveticaNeue", Helvetica, Arial, sans-serif !important; }

h1.title {
  font-weight: 900; }

body {
  font-family: "Helvetica Neue", "HelveticaNeue", "Raleway", Helvetica, Arial, sans-serif;
  font-weight: 400;
  font-size: 14px;
  line-height: 20px;
  color: #2d2d2d;
  background-color: rgba(252, 248, 244, 0.75); }

/* Skeleton grid */
.container {
  position: relative;
  width: 100%;
  max-width: 960px;
  margin: 0 auto;
  padding: 0 20px;
  box-sizing: border-box; }

.column,
.columns {
  width: 100%;
  float: left;
  box-sizing: border-box; }

/* For devices larger than 400px */
@media (min-width: 400px) {
  .container {
    width: 100%;
    padding: 0; } }
/* For devices larger than 650px */
@media (min-width: 650px) {
  .container {
    width: 100%; }

  .column,
  .columns {
    margin-left: 4%; }

  .column:first-child,
  .columns:first-child {
    margin-left: 0; }

  .one.column,
  .one.columns {
    width: 4.66666666667%; }

  .two.columns {
    width: 13.3333333333%; }

  .three.columns {
    width: 22%; }

  .four.columns {
    width: 30.6666666667%; }

  .five.columns {
    width: 39.3333333333%; }

  .six.columns {
    width: 48%; }

  .seven.columns {
    width: 56.6666666667%; }

  .eight.columns {
    width: 65.3333333333%; }

  .nine.columns {
    width: 74.0%; }

  .ten.columns {
    width: 82.6666666667%; }

  .eleven.columns {
    width: 91.3333333333%; }

  .twelve.columns {
    width: 100%;
    margin-left: 0; }

  .one-third.column {
    width: 30.6666666667%; }

  .two-thirds.column {
    width: 65.3333333333%; } }
/* Customer Overrides */
.footer {
  text-align: center;
  color: #969696;
  padding-top: 10%; }

p.module-desc {
  font-size: 1.1em;
  color: #666666; }

a.link-seesrc {
  color: #aec7d2;
  font-style: italic; }

a.link-seesrc:hover {
  color: #6c9aae; }

#toc-list {
  word-wrap: break-word; }

ul.simple-toc {
  list-style: none; }

ul.simple-toc a.reference-toplevel {
  font-weight: bold;
  color: #0077b3; }

ul.simple-toc-section {
  list-style-type: circle;
  color: #6c9aae; }

ul.simple-toc-section a.reference {
  color: #0077b3; }

cite {
  font-style: italic !important; }

dt > pre {
  border-color: rgba(0, 0, 0, 0.15);
  background-color: transparent;
  margin: 15px 0px 5px; }

dd > pre {
  border-color: rgba(0, 0, 0, 0.1);
  background-color: whitesmoke;
  margin-top: 8px; }

.item > dd {
  margin-left: 10px;
  margin-bottom: 30px; }

/* Nim line-numbered tables */
.line-nums-table {
  width: 100%;
  table-layout: fixed; }

table.line-nums-table {
  border-radius: 4px;
  border: 1px solid #cccccc;
  background-color: whitesmoke;
  border-collapse: separate;
  margin-top: 15px;
  margin-bottom: 25px; }

.line-nums-table tbody {
  border: none; }

.line-nums-table td pre {
  border: none;
  background-color: transparent; }

.line-nums-table td.blob-line-nums {
  width: 28px; }

.line-nums-table td.blob-line-nums pre {
  color: #b0b0b0;
  -webkit-filter: opacity(75%);
  text-align: right;
  border-color: transparent;
  background-color: transparent;
  padding-left: 0px;
  margin-left: 0px;
  padding-right: 0px;
  margin-right: 0px; }

/* Docgen styles */
/* Links */
a {
  color: #0077b3;
  text-decoration: none; }

a:hover,
a:focus {
  color: #00334d;
  text-decoration: underline; }

a:visited {
  color: #00334d; }

a:focus {
  outline: thin dotted #2d2d2d;
  outline: 5px auto -webkit-focus-ring-color;
  outline-offset: -2px; }

a:hover,
a:active {
  outline: 0; }

sub,
sup {
  position: relative;
  font-size: 75%;
  line-height: 0;
  vertical-align: baseline; }

sup {
  top: -0.5em; }

sub {
  bottom: -0.25em; }

img {
  width: auto;
  height: auto;
  max-width: 100%;
  vertical-align: middle;
  border: 0;
  -ms-interpolation-mode: bicubic; }

@media print {
  * {
    color: black !important;
    text-shadow: none !important;
    background: transparent !important;
    box-shadow: none !important; }

  a,
  a:visited {
    text-decoration: underline; }

  a[href]:after {
    content: " (" attr(href) ")"; }

  abbr[title]:after {
    content: " (" attr(title) ")"; }

  .ir a:after,
  a[href^="javascript:"]:after,
  a[href^="#"]:after {
    content: ""; }

  pre,
  blockquote {
    border: 1px solid #999;
    page-break-inside: avoid; }

  thead {
    display: table-header-group; }

  tr,
  img {
    page-break-inside: avoid; }

  img {
    max-width: 100% !important; }

  @page {
    margin: 0.5cm; }

  h1 {
    page-break-before: always; }

  h1.title {
    page-break-before: avoid; }

  p,
  h2,
  h3 {
    orphans: 3;
    widows: 3; }

  h2,
  h3 {
    page-break-after: avoid; } }
.img-rounded {
  -webkit-border-radius: 6px;
  -moz-border-radius: 6px;
  border-radius: 6px; }

.img-polaroid {
  padding: 4px;
  background-color: rgba(252, 248, 244, 0.75);
  border: 1px solid #ccc;
  border: 1px solid rgba(0, 0, 0, 0.2);
  -webkit-box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  -moz-box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); }

p {
  margin: 0 0 12px; }

small {
  font-size: 85%; }

strong {
  font-weight: 600; }

em {
  font-style: italic; }

cite {
  font-style: normal; }

h1,
h2,
h3,
h4,
h5,
h6 {
  font-family: "Helvetica Neue", "HelveticaNeue", "Raleway", Helvetica, Arial, sans-serif;
  font-weight: 600;
  line-height: 20px;
  color: inherit;
  text-rendering: optimizelegibility; }

h1 {
  font-size: 2em;
  padding-bottom: .15em;
  border-bottom: 1px solid #aaaaaa;
  margin-top: 1.0em;
  line-height: 1.2em; }

h1.title {
  padding-bottom: 1em;
  border-bottom: 0px;
  font-size: 2.75em; }

h2 {
  font-size: 1.5em;
  margin-top: 1.5em; }

h3 {
  font-size: 1.3em;
  font-style: italic;
  margin-top: 0.75em; }

h4 {
  font-size: 1.3em;
  margin-top: 0.5em; }

h5 {
  font-size: 1.2em;
  margin-top: 0.25em; }

h6 {
  font-size: 1.1em; }

ul,
ol {
  padding: 0;
  margin: 0 0 0px 15px; }

ul ul,
ul ol,
ol ol,
ol ul {
  margin-bottom: 0; }

li {
  line-height: 20px; }

dl {
  margin-bottom: 20px; }

dt,
dd {
  line-height: 20px; }

dt {
  font-weight: bold; }

dd {
  margin-left: 10px;
  margin-bottom: 26px; }

hr {
  margin: 20px 0;
  border: 0;
  border-top: 1px solid #eeeeee;
  border-bottom: 1px solid #ffffff; }

abbr[title],
abbr[data-original-title] {
  cursor: help;
  border-bottom: 1px dotted #999999; }

abbr.initialism {
  font-size: 90%;
  text-transform: uppercase; }

blockquote {
  padding: 0 0 0 15px;
  margin: 0 0 20px;
  border-left: 5px solid #EFEBE0; }

table.docinfo + blockquote, table.docinfo blockquote, h1 + blockquote {
  border-left: 5px solid #c9c9c9;
}

table.docinfo + blockquote p, table.docinfo blockquote p, h1 + blockquote p {
  margin-bottom: 0;
  font-size: 15px;
  font-weight: 200;
  line-height: 1.5;
  font-style: italic; }

q:before,
q:after,
blockquote:before,
blockquote:after {
  content: ""; }

address {
  display: block;
  margin-bottom: 20px;
  font-style: normal;
  line-height: 20px; }

code,
pre {
  font-family: "Source Code Pro", Monaco, Menlo, Consolas, "Courier New", monospace;
  padding: 0 3px 2px;
  font-weight: 500;
  font-size: 12px;
  color: #444444;
  -webkit-border-radius: 3px;
  -moz-border-radius: 3px;
  border-radius: 3px; }

.pre {
  font-family: "Source Code Pro", Monaco, Menlo, Consolas, "Courier New", monospace;
  font-weight: 600;
  /*color: #504da6;*/
}

code {
  padding: 2px 4px;
  color: #444444;
  white-space: nowrap;
  background-color: white;
  border: 1px solid #777777; }

pre {
  display: inline-block;
  box-sizing: border-box;
  min-width: calc(100% - 19.5px);
  padding: 9.5px;
  margin: 0 10px 0px 10px;
  font-size: 14px;
  line-height: 20px;
  white-space: pre !important;
  overflow-y: hidden;
  overflow-x: visible;
  background-color: whitesmoke;
  border: 1px solid #cccccc;
  -webkit-border-radius: 4px;
  -moz-border-radius: 4px;
  border-radius: 4px; }

pre.prettyprint {
  margin-bottom: 20px; }

pre code {
  padding: 0;
  color: inherit;
  white-space: pre;
  overflow-x: visible;
  background-color: transparent;
  border: 0; }

.pre-scrollable {
  max-height: 340px;
  overflow-y: scroll; }

table {
  max-width: 100%;
  background-color: transparent;
  border-collapse: collapse;
  border-spacing: 0; }

table th, table td {
  padding: 0px 8px 0px;
}

.table {
  width: 100%;
  margin-bottom: 20px; }

.table th,
.table td {
  padding: 8px;
  line-height: 20px;
  text-align: left;
  vertical-align: top;
  border-top: 1px solid #444444; }

.table th {
  font-weight: bold; }

.table thead th {
  vertical-align: bottom; }

.table caption + thead tr:first-child th,
.table caption + thead tr:first-child td,
.table colgroup + thead tr:first-child th,
.table colgroup + thead tr:first-child td,
.table thead:first-child tr:first-child th,
.table thead:first-child tr:first-child td {
  border-top: 0; }

.table tbody + tbody {
  border-top: 2px solid #444444; }

.table .table {
  background-color: rgba(252, 248, 244, 0.75); }

.table-condensed th,
.table-condensed td {
  padding: 4px 5px; }

.table-bordered {
  border: 1px solid #444444;
  border-collapse: separate;
  *border-collapse: collapse;
  border-left: 0;
  -webkit-border-radius: 4px;
  -moz-border-radius: 4px;
  border-radius: 4px; }

.table-bordered th,
.table-bordered td {
  border-left: 1px solid #444444; }

.table-bordered caption + thead tr:first-child th,
.table-bordered caption + tbody tr:first-child th,
.table-bordered caption + tbody tr:first-child td,
.table-bordered colgroup + thead tr:first-child th,
.table-bordered colgroup + tbody tr:first-child th,
.table-bordered colgroup + tbody tr:first-child td,
.table-bordered thead:first-child tr:first-child th,
.table-bordered tbody:first-child tr:first-child th,
.table-bordered tbody:first-child tr:first-child td {
  border-top: 0; }

.table-bordered thead:first-child tr:first-child > th:first-child,
.table-bordered tbody:first-child tr:first-child > td:first-child,
.table-bordered tbody:first-child tr:first-child > th:first-child {
  -webkit-border-top-left-radius: 4px;
  border-top-left-radius: 4px;
  -moz-border-radius-topleft: 4px; }

.table-bordered thead:first-child tr:first-child > th:last-child,
.table-bordered tbody:first-child tr:first-child > td:last-child,
.table-bordered tbody:first-child tr:first-child > th:last-child {
  -webkit-border-top-right-radius: 4px;
  border-top-right-radius: 4px;
  -moz-border-radius-topright: 4px; }

.table-bordered thead:last-child tr:last-child > th:first-child,
.table-bordered tbody:last-child tr:last-child > td:first-child,
.table-bordered tbody:last-child tr:last-child > th:first-child,
.table-bordered tfoot:last-child tr:last-child > td:first-child,
.table-bordered tfoot:last-child tr:last-child > th:first-child {
  -webkit-border-bottom-left-radius: 4px;
  border-bottom-left-radius: 4px;
  -moz-border-radius-bottomleft: 4px; }

.table-bordered thead:last-child tr:last-child > th:last-child,
.table-bordered tbody:last-child tr:last-child > td:last-child,
.table-bordered tbody:last-child tr:last-child > th:last-child,
.table-bordered tfoot:last-child tr:last-child > td:last-child,
.table-bordered tfoot:last-child tr:last-child > th:last-child {
  -webkit-border-bottom-right-radius: 4px;
  border-bottom-right-radius: 4px;
  -moz-border-radius-bottomright: 4px; }

.table-bordered tfoot + tbody:last-child tr:last-child td:first-child {
  -webkit-border-bottom-left-radius: 0;
  border-bottom-left-radius: 0;
  -moz-border-radius-bottomleft: 0; }

.table-bordered tfoot + tbody:last-child tr:last-child td:last-child {
  -webkit-border-bottom-right-radius: 0;
  border-bottom-right-radius: 0;
  -moz-border-radius-bottomright: 0; }

.table-bordered caption + thead tr:first-child th:first-child,
.table-bordered caption + tbody tr:first-child td:first-child,
.table-bordered colgroup + thead tr:first-child th:first-child,
.table-bordered colgroup + tbody tr:first-child td:first-child {
  -webkit-border-top-left-radius: 4px;
  border-top-left-radius: 4px;
  -moz-border-radius-topleft: 4px; }

.table-bordered caption + thead tr:first-child th:last-child,
.table-bordered caption + tbody tr:first-child td:last-child,
.table-bordered colgroup + thead tr:first-child th:last-child,
.table-bordered colgroup + tbody tr:first-child td:last-child {
  -webkit-border-top-right-radius: 4px;
  border-top-right-radius: 4px;
  -moz-border-radius-topright: 4px; }

table.docutils th {
  background-color: #e8e8e8; }

table.docutils tr:hover {
  background-color: whitesmoke; }

.table-striped tbody > tr:nth-child(odd) > td,
.table-striped tbody > tr:nth-child(odd) > th {
  background-color: rgba(252, 248, 244, 0.75); }

.table-hover tbody tr:hover > td,
.table-hover tbody tr:hover > th {
  background-color: rgba(241, 222, 204, 0.75); }

table td[class*="span"],
table th[class*="span"],
.row-fluid table td[class*="span"],
.row-fluid table th[class*="span"] {
  display: table-cell;
  float: none;
  margin-left: 0; }

.hero-unit {
  padding: 60px;
  margin-bottom: 30px;
  font-size: 18px;
  font-weight: 200;
  line-height: 30px;
  color: inherit;
  background-color: rgba(230, 197, 164, 0.75);
  -webkit-border-radius: 6px;
  -moz-border-radius: 6px;
  border-radius: 6px; }

.hero-unit h1 {
  margin-bottom: 0;
  font-size: 60px;
  line-height: 1;
  letter-spacing: -1px;
  color: inherit; }

.hero-unit li {
  line-height: 30px; }

/* rst2html default used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0; }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 !important; }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 !important; }

.last, .with-subtitle {
  margin-bottom: 0 !important; }

.hidden {
  display: none; }

a.toc-backref {
  text-decoration: none;
  color: #444444; }

blockquote.epigraph {
  margin: 2em 5em; }

dl.docutils dd {
  margin-bottom: 0.5em; }

object[type="image/svg+xml"], object[type="application/x-shockwave-flash"] {
  overflow: hidden; }

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/
div.abstract {
  margin: 2em 5em; }

div.abstract p.topic-title {
  font-weight: bold;
  text-align: center; }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em;
  border: medium outset;
  padding: 1em; }

div.note, div.warning {
  margin: 1.5em 0px;
  border: none; }

div.note p.admonition-title,
div.warning p.admonition-title {
  display: none; }

/* Clearfix
 * http://css-tricks.com/snippets/css/clear-fix/
 */
div.note:after,
div.warning:after {
  content: "";
  display: table;
  clear: both; }

div.note p:before,
div.warning p:before {
  display: block;
  float: left;
  font-size: 4em;
  line-height: 1em;
  margin-right: 20px;
  margin-left: 0em;
  margin-top: -10px;
  content: '\0270D';
  /*handwriting*/ }

div.warning p:before {
  content: '\026A0';
  /*warning*/ }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold;
  font-family: "Helvetica Neue", "HelveticaNeue", "Raleway", Helvetica, Arial, sans-serif; }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title, .code .error {
  color: #b30000;
  font-weight: bold;
  font-family: "Helvetica Neue", "HelveticaNeue", "Raleway", Helvetica, Arial, sans-serif; }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/
div.dedication {
  margin: 2em 5em;
  text-align: center;
  font-style: italic; }

div.dedication p.topic-title {
  font-weight: bold;
  font-style: normal; }

div.figure {
  margin-left: 2em;
  margin-right: 2em; }

div.footer, div.header {
  clear: both;
  font-size: smaller; }

div.line-block {
  display: block;
  margin-top: 1em;
  margin-bottom: 1em; }

div.line-block div.line-block {
  margin-top: 0;
  margin-bottom: 0;
  margin-left: 1.5em; }

div.sidebar {
  margin: 0 0 0.5em 1em;
  border: medium outset;
  padding: 1em;
  background-color: rgba(252, 248, 244, 0.75);
  width: 40%;
  float: right;
  clear: right; }

div.sidebar p.rubric {
  font-family: "Helvetica Neue", "HelveticaNeue", "Raleway", Helvetica, Arial, sans-serif;
  font-size: medium; }

div.system-messages {
  margin: 5em; }

div.system-messages h1 {
  color: #b30000; }

div.system-message {
  border: medium outset;
  padding: 1em; }

div.system-message p.system-message-title {
  color: #b30000;
  font-weight: bold; }

div.topic {
  margin: 2em; }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em; }

h1.title {
  text-align: center; }

h2.subtitle {
  text-align: center; }

hr.docutils {
  width: 75%; }

img.align-left, .figure.align-left, object.align-left {
  clear: left;
  float: left;
  margin-right: 1em; }

img.align-right, .figure.align-right, object.align-right {
  clear: right;
  float: right;
  margin-left: 1em; }

img.align-center, .figure.align-center, object.align-center {
  display: block;
  margin-left: auto;
  margin-right: auto; }

.align-left {
  text-align: left; }

.align-center {
  clear: both;
  text-align: center; }

.align-right {
  text-align: right; }

/* reset inner alignment in figures */
div.align-right {
  text-align: inherit; }

/* div.align-center * { */
/*   text-align: left } */
ol.simple, ul.simple {
  margin-bottom: 1em; }

ol.arabic {
  list-style: decimal; }

ol.loweralpha {
  list-style: lower-alpha; }

ol.upperalpha {
  list-style: upper-alpha; }

ol.lowerroman {
  list-style: lower-roman; }

ol.upperroman {
  list-style: upper-roman; }

p.attribution {
  text-align: right;
  margin-left: 50%; }

p.caption {
  font-style: italic; }

p.credits {
  font-style: italic;
  font-size: smaller; }

p.label {
  white-space: nowrap; }

p.rubric {
  font-weight: bold;
  font-size: larger;
  color: maroon;
  text-align: center; }

p.sidebar-title {
  font-family: "Helvetica Neue", "HelveticaNeue", "Raleway", Helvetica, Arial, sans-serif;
  font-weight: bold;
  font-size: larger; }

p.sidebar-subtitle {
  font-family: "Helvetica Neue", "HelveticaNeue", "Raleway", Helvetica, Arial, sans-serif;
  font-weight: bold; }

p.topic-title {
  font-weight: bold; }

pre.address {
  margin-bottom: 0;
  margin-top: 0;
  font: inherit; }

pre.literal-block, pre.doctest-block, pre.math, pre.code {
  margin-left: 2em;
  margin-right: 2em; }

pre.code .ln {
  color: grey; }

/* line numbers */
pre.code, code {
  background-color: #eeeeee; }

pre.code .comment, code .comment {
  color: #5c6576; }

pre.code .keyword, code .keyword {
  color: #3B0D06;
  font-weight: bold; }

pre.code .literal.string, code .literal.string {
  color: #0c5404; }

pre.code .name.builtin, code .name.builtin {
  color: #352b84; }

pre.code .deleted, code .deleted {
  background-color: #DEB0A1; }

pre.code .inserted, code .inserted {
  background-color: #A3D289; }

span.classifier {
  font-family: "Helvetica Neue", "HelveticaNeue", "Raleway", Helvetica, Arial, sans-serif;
  font-style: oblique; }

span.classifier-delimiter {
  font-family: "Helvetica Neue", "HelveticaNeue", "Raleway", Helvetica, Arial, sans-serif;
  font-weight: bold; }

span.interpreted {
  font-family: "Helvetica Neue", "HelveticaNeue", "Raleway", Helvetica, Arial, sans-serif; }

span.option {
  white-space: nowrap; }

span.pre {
  white-space: pre; }

span.problematic {
  color: #b30000; }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80%; }

table.citation {
  border-left: solid 1px #666666;
  margin-left: 1px; }

table.docinfo {
  margin: 0em;
  margin-top: 2em;
  margin-bottom: 2em;
  font-family: "Raleway", "Helvetica Neue", "HelveticaNeue", Helvetica, Arial, sans-serif !important;
  color: #444444; }

table.docutils {
  margin-top: 0.5em;
  margin-bottom: 0.5em; }

table.footnote {
  border-left: solid 1px #2d2d2d;
  margin-left: 1px; }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em;
  padding-right: 0.5em;
  vertical-align: top; }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: 700;
  text-align: left;
  white-space: nowrap;
  padding-left: 0; }

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100%; }

ul.auto-toc {
  list-style-type: none; }

span.DecNumber {
  color: #252dbe; }

span.BinNumber {
  color: #252dbe; }

span.HexNumber {
  color: #252dbe; }

span.OctNumber {
  color: #252dbe; }

span.FloatNumber {
  color: #252dbe; }

span.Identifier {
  color: #3b3b3b; }

span.Keyword {
  font-weight: 600;
  color: #5e8f60; }

span.StringLit {
  color: #a4255b; }

span.LongStringLit {
  color: #a4255b; }

span.CharLit {
  color: #a4255b; }

span.EscapeSequence {
  color: black; }

span.Operator {
  color: black; }

span.Punctuation {
  color: black; }

span.Comment, span.LongComment {
  font-style: italic;
  font-weight: 400;
  color: #484a86; }

span.RegularExpression {
  color: darkviolet; }

span.TagStart {
  color: darkviolet; }

span.TagEnd {
  color: darkviolet; }

span.Key {
  color: #252dbe; }

span.Value {
  color: #252dbe; }

span.RawData {
  color: #a4255b; }

span.Assembler {
  color: #252dbe; }

span.Preprocessor {
  color: #252dbe; }

span.Directive {
  color: #252dbe; }

span.Command, span.Rule, span.Hyperlink, span.Label, span.Reference,
span.Other {
  color: black; }

/* Pop type, const, proc, and iterator defs in nim def blocks */
dt pre > span.Identifier, dt pre > span.Operator {
  color: #155da4;
  font-weight: 700; }

dt pre > span.Identifier ~ span.Identifier, dt pre > span.Operator ~ span.Identifier {
  color: inherit;
  font-weight: inherit; }

dt pre > span.Operator ~ span.Identifier, dt pre > span.Operator ~ span.Operator {
  color: inherit;
  font-weight: inherit; }

/* Nim sprite for the footer (taken from main page favicon) */
.nim-sprite {
  display: inline-block;
  height: 12px;
  width: 12px;
  background-position: 0 0;
  background-size: 12px 12px;
  -webkit-filter: opacity(50%);
  background-repeat: no-repeat;
  background-image: url("data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AAAAAAUAAAAF////AP///wD///8A////AP///wD///8A////AP///wD///8A////AAAAAAIAAABbAAAAlQAAAKIAAACbAAAAmwAAAKIAAACVAAAAWwAAAAL///8A////AP///wD///8A////AAAAABQAAADAAAAAYwAAAA3///8A////AP///wD///8AAAAADQAAAGMAAADAAAAAFP///wD///8A////AP///wAAAACdAAAAOv///wD///8A////AP///wD///8A////AP///wD///8AAAAAOgAAAJ3///8A////AP///wAAAAAnAAAAcP///wAAAAAoAAAASv///wD///8A////AP///wAAAABKAAAAKP///wAAAABwAAAAJ////wD///8AAAAAgQAAABwAAACIAAAAkAAAAJMAAACtAAAAFQAAABUAAACtAAAAkwAAAJAAAACIAAAAHAAAAIH///8A////AAAAAKQAAACrAAAAaP///wD///8AAAAARQAAANIAAADSAAAARf///wD///8AAAAAaAAAAKsAAACk////AAAAADMAAACcAAAAnQAAABj///8A////AP///wAAAAAYAAAAGP///wD///8A////AAAAABgAAACdAAAAnAAAADMAAAB1AAAAwwAAAP8AAADpAAAAsQAAAE4AAAAb////AP///wAAAAAbAAAATgAAALEAAADpAAAA/wAAAMMAAAB1AAAAtwAAAOkAAAD/AAAA/wAAAP8AAADvAAAA3gAAAN4AAADeAAAA3gAAAO8AAAD/AAAA/wAAAP8AAADpAAAAtwAAAGUAAAA/AAAA3wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAADfAAAAPwAAAGX///8A////AAAAAEgAAADtAAAAvwAAAL0AAADGAAAA7wAAAO8AAADGAAAAvQAAAL8AAADtAAAASP///wD///8A////AP///wD///8AAAAAO////wD///8A////AAAAAIcAAACH////AP///wD///8AAAAAO////wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A//8AAP//AAD4HwAA7/cAAN/7AAD//wAAoYUAAJ55AACf+QAAh+EAAAAAAADAAwAA4AcAAP5/AAD//wAA//8AAA==");
  margin-bottom: -5px; }
</style>

</head>
<body>
<div class="document" id="documentId">
  <div class="container">
    <h1 class="title">Internals of the Nim Compiler</h1>
    <div class="row">
  <div class="three columns">
  <ul class="simple simple-toc" id="toc-list">
<li><a class="reference" id="directory-structure_toc" href="#directory-structure">Directory structure</a></li>
<li><a class="reference" id="bootstrapping-the-compiler_toc" href="#bootstrapping-the-compiler">Bootstrapping the compiler</a></li>
<li><a class="reference" id="coding-guidelines_toc" href="#coding-guidelines">Coding Guidelines</a></li>
<li><a class="reference" id="porting-to-new-platforms_toc" href="#porting-to-new-platforms">Porting to new platforms</a></li>
<li><a class="reference" id="runtime-type-information_toc" href="#runtime-type-information">Runtime type information</a></li>
<li><a class="reference" id="debugging-the-compiler_toc" href="#debugging-the-compiler">Debugging the compiler</a></li>
<li><a class="reference" id="the-compiler-s-architecture_toc" href="#the-compiler-s-architecture">The compiler's architecture</a></li>
<ul class="simple"><li><a class="reference" id="short-description-of-nim-s-modules_toc" href="#short-description-of-nim-s-modules">Short description of Nim's modules</a></li>
<li><a class="reference" id="the-syntax-tree_toc" href="#the-syntax-tree">The syntax tree</a></li>
</ul><li><a class="reference" id="how-the-rtl-is-compiled_toc" href="#how-the-rtl-is-compiled">How the RTL is compiled</a></li>
<li><a class="reference" id="compilation-cache_toc" href="#compilation-cache">Compilation cache</a></li>
<ul class="simple"><li><a class="reference" id="frontend-issues_toc" href="#frontend-issues">Frontend issues</a></li>
<ul class="simple"><li><a class="reference" id="methods-and-type-converters_toc" href="#methods-and-type-converters">Methods and type converters</a></li>
<li><a class="reference" id="generics_toc" href="#generics">Generics</a></li>
</ul><li><a class="reference" id="backend-issues_toc" href="#backend-issues">Backend issues</a></li>
</ul><li><a class="reference" id="debugging-nim-s-memory-management_toc" href="#debugging-nim-s-memory-management">Debugging Nim's memory management</a></li>
<li><a class="reference" id="the-garbage-collector_toc" href="#the-garbage-collector">The Garbage Collector</a></li>
<ul class="simple"><li><a class="reference" id="introduction_toc" href="#introduction">Introduction</a></li>
<li><a class="reference" id="the-cellset-data-structure_toc" href="#the-cellset-data-structure">The CellSet data structure</a></li>
<li><a class="reference" id="further-complications_toc" href="#further-complications">Further complications</a></li>
</ul><li><a class="reference" id="code-generation-for-closures_toc" href="#code-generation-for-closures">Code generation for closures</a></li>
<ul class="simple"><li><a class="reference" id="design_toc" href="#design">Design</a></li>
<li><a class="reference" id="alternative_toc" href="#alternative">Alternative</a></li>
<li><a class="reference" id="accumulator_toc" href="#accumulator">Accumulator</a></li>
<li><a class="reference" id="internals_toc" href="#internals">Internals</a></li>
</ul>
</ul>

  </div>
  <div class="nine columns" id="content">
  <p class="module-desc"><table class="docinfo" frame="void" rules="none"><col class="docinfo-name" /><col class="docinfo-content" /><tbody valign="top"><tr><th class="docinfo-name">Author:</th><td> Andreas Rumpf</td></tr>
<tr><th class="docinfo-name">Version:</th><td> |nimversion|</td></tr>
</tbody></table><blockquote><p>&quot;Abstraction is layering ignorance on top of reality.&quot; -- unknown</p></blockquote>

<h1><a class="toc-backref" id="directory-structure" href="#directory-structure">Directory structure</a></h1><p>The Nim project's directory structure is:</p>
<table border="1" class="docutils"><tr><th>Path</th><th>Purpose</th></tr>
<tr><td><tt class="docutils literal"><span class="pre">bin</span></tt></td><td>generated binary files</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">build</span></tt></td><td>generated C code for the installation</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">compiler</span></tt></td><td>the Nim compiler itself; note that this code has been translated from a bootstrapping version written in Pascal, so the code is <strong>not</strong> a poster child of good Nim code</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">config</span></tt></td><td>configuration files for Nim</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">dist</span></tt></td><td>additional packages for the distribution</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">doc</span></tt></td><td>the documentation; it is a bunch of reStructuredText files</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">lib</span></tt></td><td>the Nim library</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">web</span></tt></td><td>website of Nim; generated by <tt class="docutils literal"><span class="pre">nimweb</span></tt> from the <tt class="docutils literal"><span class="pre">*.txt</span></tt> and <tt class="docutils literal"><span class="pre">*.tmpl</span></tt> files</td></tr>
</table>
<h1><a class="toc-backref" id="bootstrapping-the-compiler" href="#bootstrapping-the-compiler">Bootstrapping the compiler</a></h1><p>As of version 0.8.5 the compiler is maintained in Nim. (The first versions have been implemented in Object Pascal.) The Python-based build system has been rewritten in Nim too.</p>
<p>Compiling the compiler is a simple matter of running:<pre>
nim c koch.nim
./koch boot</pre>
</p>
<p>For a release version use:<pre>
nim c koch.nim
./koch boot -d:release</pre>
</p>
<p>And for a debug version compatible with GDB:<pre>
nim c koch.nim
./koch boot --debuginfo --linedir:on</pre>
</p>
<p>The <tt class="docutils literal"><span class="pre">koch</span></tt> program is Nim's maintenance script. It is a replacement for make and shell scripting with the advantage that it is much more portable. More information about its options can be found in the <a class="reference external" href="koch.html">koch</a> documentation.</p>

<h1><a class="toc-backref" id="coding-guidelines" href="#coding-guidelines">Coding Guidelines</a></h1><ul class="simple"><li>Use CamelCase, not underscored_identifiers.</li>
<li>Indent with two spaces.</li>
<li>Max line length is 80 characters.</li>
<li>Provide spaces around binary operators if that enhances readability.</li>
<li>Use a space after a colon, but not before it.</li>
<li>Start types with a capital <tt class="docutils literal"><span class="pre">T</span></tt>, unless they are pointers/references which start with <tt class="docutils literal"><span class="pre">P</span></tt>.</li>
</ul>
<p>See also the <a class="reference external" href="apis.html">API naming design</a> document.</p>

<h1><a class="toc-backref" id="porting-to-new-platforms" href="#porting-to-new-platforms">Porting to new platforms</a></h1><p>Porting Nim to a new architecture is pretty easy, since C is the most portable programming language (within certain limits) and Nim generates C code, porting the code generator is not necessary.</p>
<p>POSIX-compliant systems on conventional hardware are usually pretty easy to port: Add the platform to <tt class="docutils literal"><span class="pre">platform</span></tt> (if it is not already listed there), check that the OS, System modules work and recompile Nim.</p>
<p>The only case where things aren't as easy is when the garbage collector needs some assembler tweaking to work. The standard version of the GC uses C's <tt class="docutils literal"><span class="pre">setjmp</span></tt> function to store all registers on the hardware stack. It may be necessary that the new platform needs to replace this generic code by some assembler code.</p>

<h1><a class="toc-backref" id="runtime-type-information" href="#runtime-type-information">Runtime type information</a></h1><p><em>Runtime type information</em> (RTTI) is needed for several aspects of the Nim programming language:</p>
<dl class="docutils"><dt>Garbage collection</dt>
<dd>The most important reason for RTTI. Generating traversal procedures produces bigger code and is likely to be slower on modern hardware as dynamic procedure binding is hard to predict.</dd>
<dt>Complex assignments</dt>
<dd>Sequences and strings are implemented as pointers to resizeable buffers, but Nim requires copying for assignments. Apart from RTTI the compiler could generate copy procedures for any type that needs one. However, this would make the code bigger and the RTTI is likely already there for the GC.</dd>
</dl>
<p>We already know the type information as a graph in the compiler. Thus we need to serialize this graph as RTTI for C code generation. Look at the file <tt class="docutils literal"><span class="pre">lib/system/hti.nim</span></tt> for more information.</p>

<h1><a class="toc-backref" id="debugging-the-compiler" href="#debugging-the-compiler">Debugging the compiler</a></h1><p>You can of course use GDB or Visual Studio to debug the compiler (via <tt class="docutils literal"><span class="pre">--debuginfo --lineDir:on</span></tt>). However, there are also lots of procs that aid in debugging:</p>
<pre><span class="Comment"># pretty prints the Nim AST</span>
<span class="Identifier">echo</span> <span class="Identifier">renderTree</span><span class="Punctuation">(</span><span class="Identifier">someNode</span><span class="Punctuation">)</span>
<span class="Comment"># outputs some JSON representation</span>
<span class="Identifier">debug</span><span class="Punctuation">(</span><span class="Identifier">someNode</span><span class="Punctuation">)</span>
<span class="Comment"># pretty prints some type</span>
<span class="Identifier">echo</span> <span class="Identifier">typeToString</span><span class="Punctuation">(</span><span class="Identifier">someType</span><span class="Punctuation">)</span>
<span class="Identifier">debug</span><span class="Punctuation">(</span><span class="Identifier">someType</span><span class="Punctuation">)</span>
<span class="Identifier">echo</span> <span class="Identifier">symbol</span><span class="Operator">.</span><span class="Identifier">name</span><span class="Operator">.</span><span class="Identifier">s</span>
<span class="Identifier">debug</span><span class="Punctuation">(</span><span class="Identifier">symbol</span><span class="Punctuation">)</span>
<span class="Comment"># pretty prints the Nim ast, but annotates symbol IDs:</span>
<span class="Identifier">echo</span> <span class="Identifier">renderTree</span><span class="Punctuation">(</span><span class="Identifier">someNode</span><span class="Punctuation">,</span> <span class="Punctuation">{</span><span class="Identifier">renderIds</span><span class="Punctuation">}</span><span class="Punctuation">)</span>
<span class="Keyword">if</span> <span class="Identifier">n</span><span class="Operator">.</span><span class="Identifier">info</span> <span class="Operator">??</span> <span class="StringLit">&quot;temp.nim&quot;</span><span class="Punctuation">:</span>
  <span class="Comment"># only output when it comes from &quot;temp.nim&quot;</span>
  <span class="Identifier">echo</span> <span class="Identifier">renderTree</span><span class="Punctuation">(</span><span class="Identifier">n</span><span class="Punctuation">)</span>
<span class="Keyword">if</span> <span class="Identifier">n</span><span class="Operator">.</span><span class="Identifier">info</span> <span class="Operator">??</span> <span class="StringLit">&quot;temp.nim&quot;</span><span class="Punctuation">:</span>
  <span class="Comment"># why does it process temp.nim here?</span>
  <span class="Identifier">writeStackTrace</span><span class="Punctuation">(</span><span class="Punctuation">)</span></pre><p>To create a new compiler for each run, use <tt class="docutils literal"><span class="pre">koch temp</span></tt>:<pre>
./koch temp c /tmp/test.nim</pre>
</p>
<p><tt class="docutils literal"><span class="pre">koch temp</span></tt> creates a debug build of the compiler, which is useful to create stacktraces for compiler debugging.</p>
<p><tt class="docutils literal"><span class="pre">koch temp</span></tt> returns 125 as the exit code in case the compiler compilation fails. This exit code tells <tt class="docutils literal"><span class="pre">git bisect</span></tt> to skip the current commit.:<pre>
git bisect start bad-commit good-commit
git bisect ./koch -r c test-source.nim</pre>
</p>

<h1><a class="toc-backref" id="the-compiler-s-architecture" href="#the-compiler-s-architecture">The compiler's architecture</a></h1><p>Nim uses the classic compiler architecture: A lexer/scanner feds tokens to a parser. The parser builds a syntax tree that is used by the code generator. This syntax tree is the interface between the parser and the code generator. It is essential to understand most of the compiler's code.</p>
<p>In order to compile Nim correctly, type-checking has to be separated from parsing. Otherwise generics cannot work.</p>

<h2><a class="toc-backref" id="short-description-of-nim-s-modules" href="#short-description-of-nim-s-modules">Short description of Nim's modules</a></h2><table border="1" class="docutils"><tr><th>Module</th><th>Description</th></tr>
<tr><td>nim          </td><td>main module: parses the command line and calls <tt class="docutils literal"><span class="pre">main.MainCommand</span></tt></td></tr>
<tr><td>main</td><td>implements the top-level command dispatching</td></tr>
<tr><td>nimconf</td><td>implements the config file reader</td></tr>
<tr><td>syntaxes</td><td>dispatcher for the different parsers and filters</td></tr>
<tr><td>filter_tmpl</td><td>standard template filter (<tt class="docutils literal"><span class="pre">#! stdtempl</span></tt>)</td></tr>
<tr><td>lexbase</td><td>buffer handling of the lexical analyser</td></tr>
<tr><td>lexer</td><td>lexical analyser</td></tr>
<tr><td>parser</td><td>Nim's parser</td></tr>
<tr><td>renderer</td><td>Nim code renderer (AST back to its textual form)</td></tr>
<tr><td>options</td><td>contains global and local compiler options</td></tr>
<tr><td>ast</td><td>type definitions of the abstract syntax tree (AST) and node constructors</td></tr>
<tr><td>astalgo</td><td>algorithms for containers of AST nodes; converting the AST to YAML; the symbol table</td></tr>
<tr><td>passes</td><td>implement the passes manager for passes over the AST</td></tr>
<tr><td>trees</td><td>some algorithms for nodes; this module is less important</td></tr>
<tr><td>types</td><td>module for traversing type graphs; also contain several helpers for dealing with types</td></tr>
<tr><td></td><td></td></tr>
<tr><td>sigmatch</td><td>contains the matching algorithm that is used for proc calls</td></tr>
<tr><td>semexprs</td><td>contains the semantic checking phase for expressions</td></tr>
<tr><td>semstmts</td><td>contains the semantic checking phase for statements</td></tr>
<tr><td>semtypes</td><td>contains the semantic checking phase for types</td></tr>
<tr><td>seminst</td><td>instantiation of generic procs and types</td></tr>
<tr><td>semfold</td><td>contains code to deal with constant folding</td></tr>
<tr><td>semthreads</td><td>deep program analysis for threads</td></tr>
<tr><td>evals</td><td>contains an AST interpreter for compile time evaluation</td></tr>
<tr><td>pragmas</td><td>semantic checking of pragmas</td></tr>
<tr><td></td><td></td></tr>
<tr><td>idents</td><td>implements a general mapping from identifiers to an internal representation (<tt class="docutils literal"><span class="pre">PIdent</span></tt>) that is used so that a simple id-comparison suffices to say whether two Nim identifiers are equivalent</td></tr>
<tr><td>ropes</td><td>implements long strings represented as trees for lazy evaluation; used mainly by the code generators</td></tr>
<tr><td></td><td></td></tr>
<tr><td>transf</td><td>transformations on the AST that need to be done before code generation</td></tr>
<tr><td>cgen</td><td>main file of the C code generator</td></tr>
<tr><td>ccgutils</td><td>contains helpers for the C code generator</td></tr>
<tr><td>ccgtypes</td><td>the generator for C types</td></tr>
<tr><td>ccgstmts</td><td>the generator for statements</td></tr>
<tr><td>ccgexprs</td><td>the generator for expressions</td></tr>
<tr><td>extccomp</td><td>this module calls the C compiler and linker; interesting if you want to add support for a new C compiler</td></tr>
</table>
<h2><a class="toc-backref" id="the-syntax-tree" href="#the-syntax-tree">The syntax tree</a></h2><p>The syntax tree consists of nodes which may have an arbitrary number of children. Types and symbols are represented by other nodes, because they may contain cycles. The AST changes its shape after semantic checking. This is needed to make life easier for the code generators. See the &quot;ast&quot; module for the type definitions. The <a class="reference external" href="macros.html">macros</a> module contains many examples how the AST represents each syntactic structure.</p>

<h1><a class="toc-backref" id="how-the-rtl-is-compiled" href="#how-the-rtl-is-compiled">How the RTL is compiled</a></h1><p>The <tt class="docutils literal"><span class="pre">system</span></tt> module contains the part of the RTL which needs support by compiler magic (and the stuff that needs to be in it because the spec says so). The C code generator generates the C code for it just like any other module. However, calls to some procedures like <tt class="docutils literal"><span class="pre">addInt</span></tt> are inserted by the CCG. Therefore the module <tt class="docutils literal"><span class="pre">magicsys</span></tt> contains a table (<tt class="docutils literal"><span class="pre">compilerprocs</span></tt>) with all symbols that are marked as <tt class="docutils literal"><span class="pre">compilerproc</span></tt>. <tt class="docutils literal"><span class="pre">compilerprocs</span></tt> are needed by the code generator. A <tt class="docutils literal"><span class="pre">magic</span></tt> proc is not the same as a <tt class="docutils literal"><span class="pre">compilerproc</span></tt>: A <tt class="docutils literal"><span class="pre">magic</span></tt> is a proc that needs compiler magic for its semantic checking, a <tt class="docutils literal"><span class="pre">compilerproc</span></tt> is a proc that is used by the code generator.</p>

<h1><a class="toc-backref" id="compilation-cache" href="#compilation-cache">Compilation cache</a></h1><p>The implementation of the compilation cache is tricky: There are lots of issues to be solved for the front- and backend. In the following sections <em>global</em> means <em>shared between modules</em> or <em>property of the whole program</em>.</p>

<h2><a class="toc-backref" id="frontend-issues" href="#frontend-issues">Frontend issues</a></h2>
<h3><a class="toc-backref" id="methods-and-type-converters" href="#methods-and-type-converters">Methods and type converters</a></h3><p>Nim contains language features that are <em>global</em>. The best example for that are multi methods: Introducing a new method with the same name and some compatible object parameter means that the method's dispatcher needs to take the new method into account. So the dispatching logic is only completely known after the whole program has been translated!</p>
<p>Other features that are <em>implicitly</em> triggered cause problems for modularity too. Type converters fall into this category:</p>
<pre><span class="Comment"># module A</span>
<span class="Keyword">converter</span> <span class="Identifier">toBool</span><span class="Punctuation">(</span><span class="Identifier">x</span><span class="Punctuation">:</span> <span class="Identifier">int</span><span class="Punctuation">)</span><span class="Punctuation">:</span> <span class="Identifier">bool</span> <span class="Operator">=</span>
  <span class="Identifier">result</span> <span class="Operator">=</span> <span class="Identifier">x</span> <span class="Operator">!=</span> <span class="DecNumber">0</span></pre><pre><span class="Comment"># module B</span>
<span class="Keyword">import</span> <span class="Identifier">A</span>

<span class="Keyword">if</span> <span class="DecNumber">1</span><span class="Punctuation">:</span>
  <span class="Identifier">echo</span> <span class="StringLit">&quot;ugly, but should work&quot;</span></pre><p>If in the above example module <tt class="docutils literal"><span class="pre">B</span></tt> is re-compiled, but <tt class="docutils literal"><span class="pre">A</span></tt> is not then <tt class="docutils literal"><span class="pre">B</span></tt> needs to be aware of <tt class="docutils literal"><span class="pre">toBool</span></tt> even though  <tt class="docutils literal"><span class="pre">toBool</span></tt> is not referenced in <tt class="docutils literal"><span class="pre">B</span></tt> <em>explicitly</em>.</p>
<p>Both the multi method and the type converter problems are solved by storing them in special sections in the ROD file that are loaded <em>unconditionally</em> when the ROD file is read.</p>

<h3><a class="toc-backref" id="generics" href="#generics">Generics</a></h3><p>If we generate an instance of a generic, we'd like to re-use that instance if possible across module boundaries. However, this is not possible if the compilation cache is enabled. So we give up then and use the caching of generics only per module, not per project. This means that <tt class="docutils literal"><span class="pre">--symbolFiles:on</span></tt> hurts a bit for efficiency. A better solution would be to persist the instantiations in a global cache per project. This might be implemented in later versions.</p>

<h2><a class="toc-backref" id="backend-issues" href="#backend-issues">Backend issues</a></h2><ul class="simple"><li>Init procs must not be &quot;forgotten&quot; to be called.</li>
<li>Files must not be &quot;forgotten&quot; to be linked.</li>
<li>Anything that is contained in <tt class="docutils literal"><span class="pre">nim__dat.c</span></tt> is shared between modules implicitly.</li>
<li>Method dispatchers are global.</li>
<li>DLL loading via <tt class="docutils literal"><span class="pre">dlsym</span></tt> is global.</li>
<li>Emulated thread vars are global.</li>
</ul>
<p>However the biggest problem is that dead code elimination breaks modularity! To see why, consider this scenario: The module <tt class="docutils literal"><span class="pre">G</span></tt> (for example the huge Gtk2 module...) is compiled with dead code elimination turned on. So none of <tt class="docutils literal"><span class="pre">G</span></tt>'s procs is generated at all.</p>
<p>Then module <tt class="docutils literal"><span class="pre">B</span></tt> is compiled that requires <tt class="docutils literal"><span class="pre">G.P1</span></tt>. Ok, no problem, <tt class="docutils literal"><span class="pre">G.P1</span></tt> is loaded from the symbol file and <tt class="docutils literal"><span class="pre">G.c</span></tt> now contains <tt class="docutils literal"><span class="pre">G.P1</span></tt>.</p>
<p>Then module <tt class="docutils literal"><span class="pre">A</span></tt> (that depends onto <tt class="docutils literal"><span class="pre">B</span></tt> and <tt class="docutils literal"><span class="pre">G</span></tt>) is compiled and <tt class="docutils literal"><span class="pre">B</span></tt> and <tt class="docutils literal"><span class="pre">G</span></tt> are left unchanged. <tt class="docutils literal"><span class="pre">A</span></tt> requires <tt class="docutils literal"><span class="pre">G.P2</span></tt>.</p>
<p>So now <tt class="docutils literal"><span class="pre">G.c</span></tt> MUST contain both <tt class="docutils literal"><span class="pre">P1</span></tt> and <tt class="docutils literal"><span class="pre">P2</span></tt>, but we haven't even loaded <tt class="docutils literal"><span class="pre">P1</span></tt> from the symbol file, nor do we want to because we then quickly would restore large parts of the whole program. But we also don't want to store <tt class="docutils literal"><span class="pre">P1</span></tt> in <tt class="docutils literal"><span class="pre">B.c</span></tt> because that would mean to store every symbol where it is referred from which ultimately means the main module and putting everything in a single C file.</p>
<p>There is however another solution: The old file <tt class="docutils literal"><span class="pre">G.c</span></tt> containing <tt class="docutils literal"><span class="pre">P1</span></tt> is <strong>merged</strong> with the new file <tt class="docutils literal"><span class="pre">G.c</span></tt> containing <tt class="docutils literal"><span class="pre">P2</span></tt>. This is the solution that is implemented in the C code generator (have a look at the <tt class="docutils literal"><span class="pre">ccgmerge</span></tt> module). The merging may lead to <em>cruft</em> (aka dead code) in generated C code which can only be removed by recompiling a project with the compilation cache turned off. Nevertheless the merge solution is way superior to the cheap solution &quot;turn off dead code elimination if the compilation cache is turned on&quot;.</p>

<h1><a class="toc-backref" id="debugging-nim-s-memory-management" href="#debugging-nim-s-memory-management">Debugging Nim's memory management</a></h1><p>The following paragraphs are mostly a reminder for myself. Things to keep in mind:</p>
<ul class="simple"><li>If an assertion in Nim's memory manager or GC fails, the stack trace keeps allocating memory! Thus a stack overflow may happen, hiding the real issue.</li>
<li>What seem to be C code generation problems is often a bug resulting from not producing prototypes, so that some types default to <tt class="docutils literal"><span class="pre">cint</span></tt>. Testing without the <tt class="docutils literal"><span class="pre">-w</span></tt> option helps!</li>
</ul>

<h1><a class="toc-backref" id="the-garbage-collector" href="#the-garbage-collector">The Garbage Collector</a></h1>
<h2><a class="toc-backref" id="introduction" href="#introduction">Introduction</a></h2><p>I use the term <em>cell</em> here to refer to everything that is traced (sequences, refs, strings). This section describes how the new GC works.</p>
<p>The basic algorithm is <em>Deferrent Reference Counting</em> with cycle detection. References on the stack are not counted for better performance and easier C code generation.</p>
<p>Each cell has a header consisting of a RC and a pointer to its type descriptor. However the program does not know about these, so they are placed at negative offsets. In the GC code the type <tt class="docutils literal"><span class="pre">PCell</span></tt> denotes a pointer decremented by the right offset, so that the header can be accessed easily. It is extremely important that <tt class="docutils literal"><span class="pre">pointer</span></tt> is not confused with a <tt class="docutils literal"><span class="pre">PCell</span></tt> as this would lead to a memory corruption.</p>

<h2><a class="toc-backref" id="the-cellset-data-structure" href="#the-cellset-data-structure">The CellSet data structure</a></h2><p>The GC depends on an extremely efficient datastructure for storing a set of pointers - this is called a <tt class="docutils literal"><span class="pre">TCellSet</span></tt> in the source code. Inserting, deleting and searching are done in constant time. However, modifying a <tt class="docutils literal"><span class="pre">TCellSet</span></tt> during traversation leads to undefined behaviour.</p>
<pre><span class="Keyword">type</span>
  <span class="Identifier">TCellSet</span> <span class="Comment"># hidden</span>

<span class="Keyword">proc</span> <span class="Identifier">cellSetInit</span><span class="Punctuation">(</span><span class="Identifier">s</span><span class="Punctuation">:</span> <span class="Keyword">var</span> <span class="Identifier">TCellSet</span><span class="Punctuation">)</span> <span class="Comment"># initialize a new set</span>
<span class="Keyword">proc</span> <span class="Identifier">cellSetDeinit</span><span class="Punctuation">(</span><span class="Identifier">s</span><span class="Punctuation">:</span> <span class="Keyword">var</span> <span class="Identifier">TCellSet</span><span class="Punctuation">)</span> <span class="Comment"># empty the set and free its memory</span>
<span class="Keyword">proc</span> <span class="Identifier">incl</span><span class="Punctuation">(</span><span class="Identifier">s</span><span class="Punctuation">:</span> <span class="Keyword">var</span> <span class="Identifier">TCellSet</span><span class="Punctuation">,</span> <span class="Identifier">elem</span><span class="Punctuation">:</span> <span class="Identifier">PCell</span><span class="Punctuation">)</span> <span class="Comment"># include an element</span>
<span class="Keyword">proc</span> <span class="Identifier">excl</span><span class="Punctuation">(</span><span class="Identifier">s</span><span class="Punctuation">:</span> <span class="Keyword">var</span> <span class="Identifier">TCellSet</span><span class="Punctuation">,</span> <span class="Identifier">elem</span><span class="Punctuation">:</span> <span class="Identifier">PCell</span><span class="Punctuation">)</span> <span class="Comment"># exclude an element</span>

<span class="Keyword">proc</span> <span class="Punctuation">`</span><span class="Keyword">in</span><span class="Punctuation">`</span><span class="Punctuation">(</span><span class="Identifier">elem</span><span class="Punctuation">:</span> <span class="Identifier">PCell</span><span class="Punctuation">,</span> <span class="Identifier">s</span><span class="Punctuation">:</span> <span class="Identifier">TCellSet</span><span class="Punctuation">)</span><span class="Punctuation">:</span> <span class="Identifier">bool</span> <span class="Comment"># tests membership</span>

<span class="Keyword">iterator</span> <span class="Identifier">elements</span><span class="Punctuation">(</span><span class="Identifier">s</span><span class="Punctuation">:</span> <span class="Identifier">TCellSet</span><span class="Punctuation">)</span><span class="Punctuation">:</span> <span class="Punctuation">(</span><span class="Identifier">elem</span><span class="Punctuation">:</span> <span class="Identifier">PCell</span><span class="Punctuation">)</span></pre><p>All the operations have to perform efficiently. Because a Cellset can become huge a hash table alone is not suitable for this.</p>
<p>We use a mixture of bitset and hash table for this. The hash table maps <em>pages</em> to a page descriptor. The page descriptor contains a bit for any possible cell address within this page. So including a cell is done as follows:</p>
<ul class="simple"><li>Find the page descriptor for the page the cell belongs to.</li>
<li>Set the appropriate bit in the page descriptor indicating that the cell points to the start of a memory block.</li>
</ul>
<p>Removing a cell is analogous - the bit has to be set to zero. Single page descriptors are never deleted from the hash table. This is not needed as the data structures needs to be rebuilt periodically anyway.</p>
<p>Complete traversal is done in this way:<pre>
for each page descriptor d:
  for each bit in d:
    if bit == 1:
      traverse the pointer belonging to this bit</pre>
</p>

<h2><a class="toc-backref" id="further-complications" href="#further-complications">Further complications</a></h2><p>In Nim the compiler cannot always know if a reference is stored on the stack or not. This is caused by var parameters. Consider this example:</p>
<pre><span class="Keyword">proc</span> <span class="Identifier">setRef</span><span class="Punctuation">(</span><span class="Identifier">r</span><span class="Punctuation">:</span> <span class="Keyword">var</span> <span class="Keyword">ref</span> <span class="Identifier">TNode</span><span class="Punctuation">)</span> <span class="Operator">=</span>
  <span class="Identifier">new</span><span class="Punctuation">(</span><span class="Identifier">r</span><span class="Punctuation">)</span>

<span class="Keyword">proc</span> <span class="Identifier">usage</span> <span class="Operator">=</span>
  <span class="Keyword">var</span>
    <span class="Identifier">r</span><span class="Punctuation">:</span> <span class="Keyword">ref</span> <span class="Identifier">TNode</span>
  <span class="Identifier">setRef</span><span class="Punctuation">(</span><span class="Identifier">r</span><span class="Punctuation">)</span> <span class="Comment"># here we should not update the reference counts, because</span>
            <span class="Comment"># r is on the stack</span>
  <span class="Identifier">setRef</span><span class="Punctuation">(</span><span class="Identifier">r</span><span class="Operator">.</span><span class="Identifier">left</span><span class="Punctuation">)</span> <span class="Comment"># here we should update the refcounts!</span></pre><p>We have to decide at runtime whether the reference is on the stack or not. The generated code looks roughly like this:</p>
<pre><span class="Keyword">void</span> <span class="Identifier">setref</span><span class="Punctuation">(</span><span class="Identifier">TNode</span><span class="Operator">**</span> <span class="Identifier">ref</span><span class="Punctuation">)</span> <span class="Punctuation">{</span>
  <span class="Identifier">unsureAsgnRef</span><span class="Punctuation">(</span><span class="Identifier">ref</span><span class="Punctuation">,</span> <span class="Identifier">newObj</span><span class="Punctuation">(</span><span class="Identifier">TNode_TI</span><span class="Punctuation">,</span> <span class="Keyword">sizeof</span><span class="Punctuation">(</span><span class="Identifier">TNode</span><span class="Punctuation">)</span><span class="Punctuation">)</span><span class="Punctuation">)</span>
<span class="Punctuation">}</span>
<span class="Keyword">void</span> <span class="Identifier">usage</span><span class="Punctuation">(</span><span class="Keyword">void</span><span class="Punctuation">)</span> <span class="Punctuation">{</span>
  <span class="Identifier">setRef</span><span class="Punctuation">(</span><span class="Operator">&amp;</span><span class="Identifier">r</span><span class="Punctuation">)</span>
  <span class="Identifier">setRef</span><span class="Punctuation">(</span><span class="Operator">&amp;</span><span class="Identifier">r</span><span class="Operator">-&gt;</span><span class="Identifier">left</span><span class="Punctuation">)</span>
<span class="Punctuation">}</span></pre><p>Note that for systems with a continuous stack (which most systems have) the check whether the ref is on the stack is very cheap (only two comparisons).</p>

<h1><a class="toc-backref" id="code-generation-for-closures" href="#code-generation-for-closures">Code generation for closures</a></h1><p>Code generation for closures is implemented by <span id="lambda-lifting_1">lambda lifting</span>.</p>

<h2><a class="toc-backref" id="design" href="#design">Design</a></h2><p>A <tt class="docutils literal"><span class="pre">closure</span></tt> proc var can call ordinary procs of the default Nim calling convention. But not the other way round! A closure is implemented as a <tt class="docutils literal"><span class="pre">tuple[prc, env]</span></tt>. <tt class="docutils literal"><span class="pre">env</span></tt> can be nil implying a call without a closure. This means that a call through a closure generates an <tt class="docutils literal"><span class="pre">if</span></tt> but the interoperability is worth the cost of the <tt class="docutils literal"><span class="pre">if</span></tt>. Thunk generation would be possible too, but it's slightly more effort to implement.</p>
<p>Tests with GCC on Amd64 showed that it's really beneficical if the 'environment' pointer is passed as the last argument, not as the first argument.</p>
<p>Proper thunk generation is harder because the proc that is to wrap could stem from a complex expression:</p>
<pre><span class="Identifier">receivesClosure</span><span class="Punctuation">(</span><span class="Identifier">returnsDefaultCC</span><span class="Punctuation">[</span><span class="Identifier">i</span><span class="Punctuation">]</span><span class="Punctuation">)</span></pre><p>A thunk would need to call 'returnsDefaultCC[i]' somehow and that would require an <em>additional</em> closure generation... Ok, not really, but it requires to pass the function to call. So we'd end up with 2 indirect calls instead of one. Another much more severe problem which this solution is that it's not GC-safe to pass a proc pointer around via a generic <tt class="docutils literal"><span class="pre">ref</span></tt> type.</p>
<p>Example code:</p>
<pre><span class="Keyword">proc</span> <span class="Identifier">add</span><span class="Punctuation">(</span><span class="Identifier">x</span><span class="Punctuation">:</span> <span class="Identifier">int</span><span class="Punctuation">)</span><span class="Punctuation">:</span> <span class="Keyword">proc</span> <span class="Punctuation">(</span><span class="Identifier">y</span><span class="Punctuation">:</span> <span class="Identifier">int</span><span class="Punctuation">)</span><span class="Punctuation">:</span> <span class="Identifier">int</span> <span class="Punctuation">{</span><span class="Operator">.</span><span class="Identifier">closure</span><span class="Operator">.</span><span class="Punctuation">}</span> <span class="Operator">=</span>
  <span class="Keyword">return</span> <span class="Keyword">proc</span> <span class="Punctuation">(</span><span class="Identifier">y</span><span class="Punctuation">:</span> <span class="Identifier">int</span><span class="Punctuation">)</span><span class="Punctuation">:</span> <span class="Identifier">int</span> <span class="Operator">=</span>
    <span class="Keyword">return</span> <span class="Identifier">x</span> <span class="Operator">+</span> <span class="Identifier">y</span>

<span class="Keyword">var</span> <span class="Identifier">add2</span> <span class="Operator">=</span> <span class="Identifier">add</span><span class="Punctuation">(</span><span class="DecNumber">2</span><span class="Punctuation">)</span>
<span class="Identifier">echo</span> <span class="Identifier">add2</span><span class="Punctuation">(</span><span class="DecNumber">5</span><span class="Punctuation">)</span> <span class="Comment">#OUT 7</span></pre><p>This should produce roughly this code:</p>
<pre><span class="Keyword">type</span>
  <span class="Identifier">PEnv</span> <span class="Operator">=</span> <span class="Keyword">ref</span> <span class="Keyword">object</span>
    <span class="Identifier">x</span><span class="Punctuation">:</span> <span class="Identifier">int</span> <span class="Comment"># data</span>

<span class="Keyword">proc</span> <span class="Identifier">anon</span><span class="Punctuation">(</span><span class="Identifier">y</span><span class="Punctuation">:</span> <span class="Identifier">int</span><span class="Punctuation">,</span> <span class="Identifier">c</span><span class="Punctuation">:</span> <span class="Identifier">PClosure</span><span class="Punctuation">)</span><span class="Punctuation">:</span> <span class="Identifier">int</span> <span class="Operator">=</span>
  <span class="Keyword">return</span> <span class="Identifier">y</span> <span class="Operator">+</span> <span class="Identifier">c</span><span class="Operator">.</span><span class="Identifier">x</span>

<span class="Keyword">proc</span> <span class="Identifier">add</span><span class="Punctuation">(</span><span class="Identifier">x</span><span class="Punctuation">:</span> <span class="Identifier">int</span><span class="Punctuation">)</span><span class="Punctuation">:</span> <span class="Keyword">tuple</span><span class="Punctuation">[</span><span class="Identifier">prc</span><span class="Punctuation">,</span> <span class="Identifier">data</span><span class="Punctuation">]</span> <span class="Operator">=</span>
  <span class="Keyword">var</span> <span class="Identifier">env</span><span class="Punctuation">:</span> <span class="Identifier">PEnv</span>
  <span class="Identifier">new</span> <span class="Identifier">env</span>
  <span class="Identifier">env</span><span class="Operator">.</span><span class="Identifier">x</span> <span class="Operator">=</span> <span class="Identifier">x</span>
  <span class="Identifier">result</span> <span class="Operator">=</span> <span class="Punctuation">(</span><span class="Identifier">anon</span><span class="Punctuation">,</span> <span class="Identifier">env</span><span class="Punctuation">)</span>

<span class="Keyword">var</span> <span class="Identifier">add2</span> <span class="Operator">=</span> <span class="Identifier">add</span><span class="Punctuation">(</span><span class="DecNumber">2</span><span class="Punctuation">)</span>
<span class="Keyword">let</span> <span class="Identifier">tmp</span> <span class="Operator">=</span> <span class="Keyword">if</span> <span class="Identifier">add2</span><span class="Operator">.</span><span class="Identifier">data</span> <span class="Operator">==</span> <span class="Keyword">nil</span><span class="Punctuation">:</span> <span class="Identifier">add2</span><span class="Operator">.</span><span class="Identifier">prc</span><span class="Punctuation">(</span><span class="DecNumber">5</span><span class="Punctuation">)</span> <span class="Keyword">else</span><span class="Punctuation">:</span> <span class="Identifier">add2</span><span class="Operator">.</span><span class="Identifier">prc</span><span class="Punctuation">(</span><span class="DecNumber">5</span><span class="Punctuation">,</span> <span class="Identifier">add2</span><span class="Operator">.</span><span class="Identifier">data</span><span class="Punctuation">)</span>
<span class="Identifier">echo</span> <span class="Identifier">tmp</span></pre><p>Beware of nesting:</p>
<pre><span class="Keyword">proc</span> <span class="Identifier">add</span><span class="Punctuation">(</span><span class="Identifier">x</span><span class="Punctuation">:</span> <span class="Identifier">int</span><span class="Punctuation">)</span><span class="Punctuation">:</span> <span class="Keyword">proc</span> <span class="Punctuation">(</span><span class="Identifier">y</span><span class="Punctuation">:</span> <span class="Identifier">int</span><span class="Punctuation">)</span><span class="Punctuation">:</span> <span class="Keyword">proc</span> <span class="Punctuation">(</span><span class="Identifier">z</span><span class="Punctuation">:</span> <span class="Identifier">int</span><span class="Punctuation">)</span><span class="Punctuation">:</span> <span class="Identifier">int</span> <span class="Punctuation">{</span><span class="Operator">.</span><span class="Identifier">closure</span><span class="Operator">.</span><span class="Punctuation">}</span> <span class="Punctuation">{</span><span class="Operator">.</span><span class="Identifier">closure</span><span class="Operator">.</span><span class="Punctuation">}</span> <span class="Operator">=</span>
  <span class="Keyword">return</span> <span class="Identifier">lamba</span> <span class="Punctuation">(</span><span class="Identifier">y</span><span class="Punctuation">:</span> <span class="Identifier">int</span><span class="Punctuation">)</span><span class="Punctuation">:</span> <span class="Keyword">proc</span> <span class="Punctuation">(</span><span class="Identifier">z</span><span class="Punctuation">:</span> <span class="Identifier">int</span><span class="Punctuation">)</span><span class="Punctuation">:</span> <span class="Identifier">int</span> <span class="Punctuation">{</span><span class="Operator">.</span><span class="Identifier">closure</span><span class="Operator">.</span><span class="Punctuation">}</span> <span class="Operator">=</span>
    <span class="Keyword">return</span> <span class="Identifier">lambda</span> <span class="Punctuation">(</span><span class="Identifier">z</span><span class="Punctuation">:</span> <span class="Identifier">int</span><span class="Punctuation">)</span><span class="Punctuation">:</span> <span class="Identifier">int</span> <span class="Operator">=</span>
      <span class="Keyword">return</span> <span class="Identifier">x</span> <span class="Operator">+</span> <span class="Identifier">y</span> <span class="Operator">+</span> <span class="Identifier">z</span>

<span class="Keyword">var</span> <span class="Identifier">add24</span> <span class="Operator">=</span> <span class="Identifier">add</span><span class="Punctuation">(</span><span class="DecNumber">2</span><span class="Punctuation">)</span><span class="Punctuation">(</span><span class="DecNumber">4</span><span class="Punctuation">)</span>
<span class="Identifier">echo</span> <span class="Identifier">add24</span><span class="Punctuation">(</span><span class="DecNumber">5</span><span class="Punctuation">)</span> <span class="Comment">#OUT 11</span></pre><p>This should produce roughly this code:</p>
<pre><span class="Keyword">type</span>
  <span class="Identifier">PEnvX</span> <span class="Operator">=</span> <span class="Keyword">ref</span> <span class="Keyword">object</span>
    <span class="Identifier">x</span><span class="Punctuation">:</span> <span class="Identifier">int</span> <span class="Comment"># data</span>
  
  <span class="Identifier">PEnvY</span> <span class="Operator">=</span> <span class="Keyword">ref</span> <span class="Keyword">object</span>
    <span class="Identifier">y</span><span class="Punctuation">:</span> <span class="Identifier">int</span>
    <span class="Identifier">ex</span><span class="Punctuation">:</span> <span class="Identifier">PEnvX</span>

<span class="Keyword">proc</span> <span class="Identifier">lambdaZ</span><span class="Punctuation">(</span><span class="Identifier">z</span><span class="Punctuation">:</span> <span class="Identifier">int</span><span class="Punctuation">,</span> <span class="Identifier">ey</span><span class="Punctuation">:</span> <span class="Identifier">PEnvY</span><span class="Punctuation">)</span><span class="Punctuation">:</span> <span class="Identifier">int</span> <span class="Operator">=</span>
  <span class="Keyword">return</span> <span class="Identifier">ey</span><span class="Operator">.</span><span class="Identifier">ex</span><span class="Operator">.</span><span class="Identifier">x</span> <span class="Operator">+</span> <span class="Identifier">ey</span><span class="Operator">.</span><span class="Identifier">y</span> <span class="Operator">+</span> <span class="Identifier">z</span>

<span class="Keyword">proc</span> <span class="Identifier">lambdaY</span><span class="Punctuation">(</span><span class="Identifier">y</span><span class="Punctuation">:</span> <span class="Identifier">int</span><span class="Punctuation">,</span> <span class="Identifier">ex</span><span class="Punctuation">:</span> <span class="Identifier">PEnvX</span><span class="Punctuation">)</span><span class="Punctuation">:</span> <span class="Keyword">tuple</span><span class="Punctuation">[</span><span class="Identifier">prc</span><span class="Punctuation">,</span> <span class="Identifier">data</span><span class="Punctuation">:</span> <span class="Identifier">PEnvY</span><span class="Punctuation">]</span> <span class="Operator">=</span>
  <span class="Keyword">var</span> <span class="Identifier">ey</span><span class="Punctuation">:</span> <span class="Identifier">PEnvY</span>
  <span class="Identifier">new</span> <span class="Identifier">ey</span>
  <span class="Identifier">ey</span><span class="Operator">.</span><span class="Identifier">y</span> <span class="Operator">=</span> <span class="Identifier">y</span>
  <span class="Identifier">ey</span><span class="Operator">.</span><span class="Identifier">ex</span> <span class="Operator">=</span> <span class="Identifier">ex</span>
  <span class="Identifier">result</span> <span class="Operator">=</span> <span class="Punctuation">(</span><span class="Identifier">lambdaZ</span><span class="Punctuation">,</span> <span class="Identifier">ey</span><span class="Punctuation">)</span>

<span class="Keyword">proc</span> <span class="Identifier">add</span><span class="Punctuation">(</span><span class="Identifier">x</span><span class="Punctuation">:</span> <span class="Identifier">int</span><span class="Punctuation">)</span><span class="Punctuation">:</span> <span class="Keyword">tuple</span><span class="Punctuation">[</span><span class="Identifier">prc</span><span class="Punctuation">,</span> <span class="Identifier">data</span><span class="Punctuation">:</span> <span class="Identifier">PEnvX</span><span class="Punctuation">]</span> <span class="Operator">=</span>
  <span class="Keyword">var</span> <span class="Identifier">ex</span><span class="Punctuation">:</span> <span class="Identifier">PEnvX</span>
  <span class="Identifier">ex</span><span class="Operator">.</span><span class="Identifier">x</span> <span class="Operator">=</span> <span class="Identifier">x</span>
  <span class="Identifier">result</span> <span class="Operator">=</span> <span class="Punctuation">(</span><span class="Identifier">labmdaY</span><span class="Punctuation">,</span> <span class="Identifier">ex</span><span class="Punctuation">)</span>

<span class="Keyword">var</span> <span class="Identifier">tmp</span> <span class="Operator">=</span> <span class="Identifier">add</span><span class="Punctuation">(</span><span class="DecNumber">2</span><span class="Punctuation">)</span>
<span class="Keyword">var</span> <span class="Identifier">tmp2</span> <span class="Operator">=</span> <span class="Identifier">tmp</span><span class="Operator">.</span><span class="Identifier">fn</span><span class="Punctuation">(</span><span class="DecNumber">4</span><span class="Punctuation">,</span> <span class="Identifier">tmp</span><span class="Operator">.</span><span class="Identifier">data</span><span class="Punctuation">)</span>
<span class="Keyword">var</span> <span class="Identifier">add24</span> <span class="Operator">=</span> <span class="Identifier">tmp2</span><span class="Operator">.</span><span class="Identifier">fn</span><span class="Punctuation">(</span><span class="DecNumber">4</span><span class="Punctuation">,</span> <span class="Identifier">tmp2</span><span class="Operator">.</span><span class="Identifier">data</span><span class="Punctuation">)</span>
<span class="Identifier">echo</span> <span class="Identifier">add24</span><span class="Punctuation">(</span><span class="DecNumber">5</span><span class="Punctuation">)</span></pre><p>We could get rid of nesting environments by always inlining inner anon procs. More useful is escape analysis and stack allocation of the environment, however.</p>

<h2><a class="toc-backref" id="alternative" href="#alternative">Alternative</a></h2><p>Process the closure of all inner procs in one pass and accumulate the environments. This is however not always possible.</p>

<h2><a class="toc-backref" id="accumulator" href="#accumulator">Accumulator</a></h2><pre><span class="Keyword">proc</span> <span class="Identifier">getAccumulator</span><span class="Punctuation">(</span><span class="Identifier">start</span><span class="Punctuation">:</span> <span class="Identifier">int</span><span class="Punctuation">)</span><span class="Punctuation">:</span> <span class="Keyword">proc</span> <span class="Punctuation">(</span><span class="Punctuation">)</span><span class="Punctuation">:</span> <span class="Identifier">int</span> <span class="Punctuation">{</span><span class="Operator">.</span><span class="Identifier">closure</span><span class="Punctuation">}</span> <span class="Operator">=</span>
  <span class="Keyword">var</span> <span class="Identifier">i</span> <span class="Operator">=</span> <span class="Identifier">start</span>
  <span class="Keyword">return</span> <span class="Identifier">lambda</span><span class="Punctuation">:</span> <span class="Identifier">int</span> <span class="Operator">=</span>
    <span class="Identifier">inc</span> <span class="Identifier">i</span>
    <span class="Keyword">return</span> <span class="Identifier">i</span>

<span class="Keyword">proc</span> <span class="Identifier">p</span> <span class="Operator">=</span>
  <span class="Keyword">var</span> <span class="Identifier">delta</span> <span class="Operator">=</span> <span class="DecNumber">7</span>
  <span class="Keyword">proc</span> <span class="Identifier">accumulator</span><span class="Punctuation">(</span><span class="Identifier">start</span><span class="Punctuation">:</span> <span class="Identifier">int</span><span class="Punctuation">)</span><span class="Punctuation">:</span> <span class="Keyword">proc</span><span class="Punctuation">(</span><span class="Punctuation">)</span><span class="Punctuation">:</span> <span class="Identifier">int</span> <span class="Operator">=</span>
    <span class="Keyword">var</span> <span class="Identifier">x</span> <span class="Operator">=</span> <span class="Identifier">start</span><span class="Operator">-</span><span class="DecNumber">1</span>
    <span class="Identifier">result</span> <span class="Operator">=</span> <span class="Keyword">proc</span> <span class="Punctuation">(</span><span class="Punctuation">)</span><span class="Punctuation">:</span> <span class="Identifier">int</span> <span class="Operator">=</span>
      <span class="Identifier">x</span> <span class="Operator">=</span> <span class="Identifier">x</span> <span class="Operator">+</span> <span class="Identifier">delta</span>
      <span class="Identifier">inc</span> <span class="Identifier">delta</span>
      <span class="Keyword">return</span> <span class="Identifier">x</span>
  
  <span class="Keyword">var</span> <span class="Identifier">a</span> <span class="Operator">=</span> <span class="Identifier">accumulator</span><span class="Punctuation">(</span><span class="DecNumber">3</span><span class="Punctuation">)</span>
  <span class="Keyword">var</span> <span class="Identifier">b</span> <span class="Operator">=</span> <span class="Identifier">accumulator</span><span class="Punctuation">(</span><span class="DecNumber">4</span><span class="Punctuation">)</span>
  <span class="Identifier">echo</span> <span class="Identifier">a</span><span class="Punctuation">(</span><span class="Punctuation">)</span> <span class="Operator">+</span> <span class="Identifier">b</span><span class="Punctuation">(</span><span class="Punctuation">)</span></pre>
<h2><a class="toc-backref" id="internals" href="#internals">Internals</a></h2><p>Lambda lifting is implemented as part of the <tt class="docutils literal"><span class="pre">transf</span></tt> pass. The <tt class="docutils literal"><span class="pre">transf</span></tt> pass generates code to setup the environment and to pass it around. However, this pass does not change the types! So we have some kind of mismatch here; on the one hand the proc expression becomes an explicit tuple, on the other hand the tyProc(ccClosure) type is not changed. For C code generation it's also important the hidden formal param is <tt class="docutils literal"><span class="pre">void*</span></tt> and not something more specialized. However the more specialized env type needs to passed to the backend somehow. We deal with this by modifying <tt class="docutils literal"><span class="pre">s.ast[paramPos]</span></tt> to contain the formal hidden parameter, but not <tt class="docutils literal"><span class="pre">s.typ</span></tt>!</p>
</p>
  
  </div>
</div>

    <div class="row">
      <div class="twelve-columns footer">
        <span class="nim-sprite"></span>
        <br>
        <small>Made with Nim. Generated: 2015-03-13 21:15:32 UTC</small>
      </div>
    </div>
  </div>
</div>

</body>
</html>
